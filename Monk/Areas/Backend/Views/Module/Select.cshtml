@{
    ViewBag.Title = ViewBag.HaviorInfo.Name + " - " + ViewBag.SysSetInfo.Name;
    Layout = ViewBag.HaviorInfo.Layout;
}

@section head{
    @ViewBag.HaviorInfo.HeadCode
}

@section crumbs{
    <label class="backend-crumbs-separator">/</label>
    <a href="#" title="系统管理">系统管理</a>
    <label class="backend-crumbs-separator">/</label>
    <a href="#" title="模块管理">模块管理</a>
    <label class="backend-crumbs-separator">/</label>
    <a href="#" title="系统栏目">系统栏目</a>
    <label class="backend-crumbs-separator">/</label>
    <a href="#" title="栏目列表">栏目列表</a>
}


@section buttons{
    <span class="list-btn" onclick="backend.checkall(this);"><i class="monk-iconfont icon-backend-quanxuan"></i><label>全选</label></span>
    <span class="list-btn" onclick="insert();"><i class="monk-iconfont icon-backend-insert"></i><label>新增</label></span>
    <span class="list-btn" onclick="detail(this);"><i class="monk-iconfont icon-backend-details"></i><label>查看</label></span>
    <span class="list-btn" onclick="update(this);"><i class="monk-iconfont icon-backend-update"></i><label>编辑</label></span>
    <span class="list-btn" onclick="deletes(this);"><i class="monk-iconfont icon-backend-delete"></i><label>删除</label></span>
    <span class="list-btn float-right search-btn" onclick="backend.openSearch()"><i class="monk-iconfont icon-backend-search-list"></i><label>搜索</label></span>
}

<div class="monk-table">
    <table>
        <thead>
            <tr>
                <th align="center" class="monk-table-status">
                    选择
                </th>
                <th align="center" class="monk-table-status">
                    图标
                </th>
                <th align="left">
                    名称
                </th>
                <th align="left" class="monk-table-status">
                    排序
                </th>
                <th align="center" class="monk-table-status">
                    开放
                </th>
                <th align="center" class="monk-table-status">
                    默认
                </th>
            </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
        </tfoot>
    </table>
</div>

@section foot{
    @ViewBag.HaviorInfo.FootCode
    @Scripts.Render("~/Assets/Backend/Linq/Script")
    <script type="text/javascript">
        function insert() {
            var ids = backend.getCheckIds();
            if (ids.length > 0) {
                window.location.href = "@Url.Action("Insert","Module")/" + ids[0];
            }
            else {
                window.location.href = "@Url.Action("Insert","Module")";
            }
        }
        function detail() {
            var ids = backend.getCheckIds();
            if (ids.length == 1) {
                window.location.href = "@Url.Action("Detail","Module",new { })/" + ids[0];
            }
            else {
                backend.Tip("只能选择一条数据进行操作");
            }
        }
        function update() {
            var ids = backend.getCheckIds();
            if (ids.length == 1) {
                window.location.href = "@Url.Action("Update","Module",new { })/" + ids[0];
            }
            else {
                backend.Tip("只能选择一条数据进行操作");
            }
        }
        function deletes() {
            var ids = backend.getCheckIds();
            if (ids.indexOf("11111111-1111-1111-1111-111111111111") > -1) {
                backend.errorTip("顶级栏目禁止删除");
            }
            else {
                if (ids.length < 1) {
                    backend.Tip("至少选择一条进行操作");
                }
                else {
                    backend.confirm("您确定要执行此操作吗？", null, function (index) {
                        backend.post("@Url.Action("Delete","Module",new { })", { ids: ids.toString() }, function (data) {
                            backend.get("@Url.Action("Modules","Module")", {}, function (data) {
                                $(".monk-table table tbody").html(getModuleTreeHtml(data.data));
                            });
                        });
                    });
                }
            }
        }
    </script>
    <script type="text/html" id="tpl">
        <tr>
            <td class="monk-td-radio">
                <span class="monk-iconfont icon-backend-checkbox list-radio" data-id="<%=obj.ModuleID %>"></span>
            </td>
            <td class="monk-table-status">
                <i class="monk-iconfont <%=obj.Iconfont %>"></i>
            </td>
            <td>
                <%=space %><%=obj.ModuleID=="11111111-1111-1111-1111-111111111111"?'<i class="monk-iconfont icon-backend-folder-open"></i> ':'<i class="monk-iconfont icon-backend-tree-line"></i>' %><label title="<%=obj.Remark %>" class="<%=obj.ParentID==" 11111111-1111-1111-1111-111111111111"?"tipcolor":"" %>"><%=obj.Name %></label><span class="module-link">[ <%=backend.setNull(obj.Url,"无") %> ]</span>
            </td>
            <td class="monk-table-status">
                <input type="number" class="list-textbox-sort" value="<%=obj.Sort %>" onkeyup="this.value=this.value.replace(/!^[0-9]*$/g,'')" onafterpaste="this.value=this.value.replace(/!^[0-9]*$/g,'')" />
            </td>
            <td class="monk-table-status">
                <%=backend.setStatus(obj.Enable) %>
            </td>
            <td class="monk-table-status">
                <%=backend.setStatus(obj.Default) %>
            </td>
        </tr>
    </script>
    <script type="text/javascript">
        // 递归生成树
        var render = monk.tppl(document.getElementById("tpl").innerHTML);
        function getModuleTreeHtml(data) {
            var treeHtml = "";
            function core(parentId, level) {
                var queryResult = Enumerable.from(data).where(function (x) { return x.ParentID == parentId; }).orderBy(function (x) { return x.Sort; }).toArray();
                if (queryResult.length > 0) {
                    level++;
                    var spaceHtml = "";
                    for (var i = 0; i < level - 1; i++) {
                        spaceHtml += '<span class="space"></span>';
                    }
                    queryResult.forEach(function (x) {
                        var merge = {
                            obj: x,
                            space: spaceHtml
                        }
                        treeHtml += render(merge);
                        core(x.ModuleID, level);
                    });
                }
                level = 0;
            }
            core("00000000-0000-0000-0000-000000000000", 0);
            return treeHtml;
        }

        $(function () {
            backend.get("@Url.Action("Modules","Module")", {}, function (data) {
                $(".monk-table table tbody").html(getModuleTreeHtml(data.data));
            });
        });
    </script>
}